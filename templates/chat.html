<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GenAI Chatbot</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* {
    box-sizing: border-box;
    font-family: "Segoe UI", Arial, sans-serif;
}

body {
    margin: 0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* ================= CONTAINER ================= */
.chat-container {
    width: 100%;
    max-width: 420px;
    height: 90vh;
    background: #fff;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    overflow: hidden;
}

/* ================= HEADER ================= */
.chat-header {
    background: #4f46e5;
    color: white;
    padding: 12px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    flex-direction: column;
    line-height: 1.2;
}

.header-title {
    font-size: 16px;
    font-weight: bold;
}

.username {
    font-size: 12px;
    opacity: 0.85;
}

.logout-btn {
    background: #ef4444;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
}

.logout-btn:hover {
    background: #dc2626;
}

/* ================= MESSAGES ================= */
.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f3f4f6;
}

.message {
    max-width: 75%;
    padding: 10px 14px;
    margin-bottom: 10px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
}

.message.user {
    background: #4f46e5;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.message.bot {
    background: #e5e7eb;
    color: #111;
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.typing {
    font-size: 13px;
    font-style: italic;
    color: #555;
    margin-bottom: 10px;
}

/* ================= INPUT ================= */
.chat-input {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
    gap: 8px;
}

.chat-input input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
}

.chat-input button {
    padding: 10px 16px;
    border-radius: 20px;
    border: none;
    background: #4f46e5;
    color: white;
    cursor: pointer;
}

.chat-input button:hover {
    background: #4338ca;
}
</style>
</head>

<body>

<div class="chat-container">

    <!-- HEADER -->
    <div class="chat-header">
        <div class="header-left">
            <div class="header-title">ü§ñ GenAI Chatbot</div>
            <div class="username" id="username"></div>
        </div>
        <button class="logout-btn" onclick="confirmLogout()">Logout</button>
    </div>

    <!-- CHAT -->
    <div id="messages" class="chat-messages"></div>

    <!-- INPUT -->
    <div class="chat-input">
    <input id="msg" type="text" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
    <!-- üé§ Voice Input button -->
    <button id="voice-btn">üéôÔ∏è</button>
</div>

</div>

<script>
/* ================= AUTH STATE ================= */
const rawUserId = localStorage.getItem("user_id");
const username = localStorage.getItem("username");
const userId = rawUserId ? parseInt(rawUserId, 10) : 1;

const usernameDiv = document.getElementById("username");
if (username) {
    usernameDiv.innerText = "Logged in as: " + username;
} else {
    usernameDiv.innerHTML = 'Demo mode ¬∑ <a href="/login" style="color:#e0e7ff;">Login</a>';
}

/* ================= LOGOUT ================= */
function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem("user_id");
        localStorage.removeItem("username");
        window.location.href = "/login";
    }
}

/* ================= CHAT UI ================= */
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("msg");

function addMessage(text, sender) {
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.innerText = text ?? "";
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* ================= LOAD HISTORY ================= */
async function loadHistory() {
    try {
        const res = await fetch(`/chat/history/${userId}`);
        const data = await res.json();

        data.history.forEach(item => {
            addMessage(item.question, "user");
            addMessage(item.answer, "bot");
        });
    } catch (err) {
        console.warn("History load failed", err);
    }
}

loadHistory();

/* ================= SEND MESSAGE ================= */
async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;

    addMessage(message, "user");
    input.value = "";

    const typing = document.createElement("div");
    typing.className = "typing";
    typing.innerText = "Bot is typing...";
    messagesDiv.appendChild(typing);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try {
        const res = await fetch("/chat/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message, user_id: userId })
        });

        const data = await res.json();
        messagesDiv.removeChild(typing);

        const reply = data.reply ?? data.answer ?? "No response";
        addMessage(reply, "bot");

    } catch (err) {
        messagesDiv.removeChild(typing);
        addMessage("Network error", "bot");
    }
}

// ================= VOICE =================
const voiceBtn = document.getElementById("voice-btn");
let recognition;
let isRecording = false;

// Check browser support
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
        isRecording = true;
        voiceBtn.innerText = "üî¥ Recording...";
    };

    recognition.onend = () => {
        isRecording = false;
        voiceBtn.innerText = "üéôÔ∏è";
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        sendMessage();  // automatically send message
    };
} else {
    voiceBtn.disabled = true;
    voiceBtn.innerText = "‚ùå No Mic Support";
}

// Start / Stop recording
voiceBtn.addEventListener("click", () => {
    if (recognition) {
        if (!isRecording) recognition.start();
        else recognition.stop();
    }
});

// ================= VOICE OUTPUT =================
function speak(text) {
    if (!text) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    window.speechSynthesis.speak(utter);
}

// Modify addMessage to play bot voice
const originalAddMessage = addMessage;
addMessage = (text, sender) => {
    originalAddMessage(text, sender);
    if (sender === "bot") speak(text);
};

/* ================= ENTER KEY ================= */
input.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});


</script>

</body>
</html>
