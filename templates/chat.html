<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GenAI Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; font-family: "Segoe UI", Arial, sans-serif; }
        body { margin: 0; background: linear-gradient(135deg, #667eea, #764ba2); height: 100vh; display: flex; justify-content: center; align-items: center; }
        .chat-container { width: 100%; max-width: 420px; height: 90vh; background: #fff; border-radius: 14px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .chat-header { background: #4f46e5; color: white; padding: 12px 14px; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: #f3f4f6; }
        .message { max-width: 75%; padding: 10px 14px; margin-bottom: 10px; border-radius: 14px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .message.user { background: #4f46e5; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .message.bot { background: #e5e7eb; color: #111; margin-right: auto; border-bottom-left-radius: 4px; }
        .chat-input { display: flex; padding: 10px; border-top: 1px solid #ddd; gap: 8px; }
        .chat-input input { flex: 1; padding: 10px 14px; border-radius: 20px; border: 1px solid #ccc; outline: none; }
        .chat-input button { padding: 10px 16px; border-radius: 20px; border: none; background: #4f46e5; color: white; cursor: pointer; }
        .typing { font-size: 12px; font-style: italic; color: #555; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div>ðŸ¤– GenAI Chatbot <br><small id="username"></small></div>
            <button onclick="logout()" style="background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer;">Logout</button>
        </div>
        <div id="messages" class="chat-messages"></div>
        <div class="chat-input">
            <input id="msg" type="text" placeholder="Type your message..." />
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
/* ================= AUTH STATE ================= */
const rawUserId = localStorage.getItem("user_id");
const username = localStorage.getItem("username");
const userId = rawUserId ? parseInt(rawUserId, 10) : 1;

const usernameDiv = document.getElementById("username");
if (username) {
    usernameDiv.innerText = "Logged in as: " + username;
}

/* ================= CHAT UI ================= */
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("msg");

function addMessage(text, sender) {
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.innerText = text ?? "";
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* ================= LOAD HISTORY ================= */
async function loadHistory() {
    try {
        const res = await fetch(`/chat/history/${userId}`);
        const data = await res.json();
        if (data.history) {
            data.history.forEach(item => {
                addMessage(item.question, "user");
                addMessage(item.answer, "bot");
            });
        }
    } catch (err) { console.warn("History load failed", err); }
}
loadHistory();

/* ================= SEND MESSAGE ================= */
async function sendMessage() {
    const message = input.value.trim();
    if (!message) return;

    addMessage(message, "user");
    input.value = "";

    const typing = document.createElement("div");
    typing.className = "typing";
    typing.innerText = "Bot is typing...";
    messagesDiv.appendChild(typing);

    try {
        // THE FIX: Use /chat/ with a slash and send JSON
        const res = await fetch("/chat/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message, user_id: userId })
        });

        const data = await res.json();
        if (messagesDiv.contains(typing)) messagesDiv.removeChild(typing);

        // THE FIX: Your backend sends "reply", not "answer"
        const reply = data.reply || "No response";
        addMessage(reply, "bot");

    } catch (err) {
        if (messagesDiv.contains(typing)) messagesDiv.removeChild(typing);
        addMessage("Network error", "bot");
    }
}

input.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});
</script>
</body>
</html>
